# Auth Hardening Report

## Summary
- Enforced non-interactive GitHub auth across code, scripts, and CI.
- Centralized OAuth2+PAT token provider with automatic failover.
- Removed legacy interactive flows and insecure patterns.

## Central Module
- Added `internal/github_auth/`:
  - `token_provider.py` (Python)
  - `tokenProvider.ts` (Node)
  - `token_provider.sh` (Bash)
  - `git_askpass.sh` for ephemeral git auth (no persistence)

## Refactors
- `scripts/github_api.sh`: now uses central provider and standard headers.
- `scripts/github_auth.sh`: no longer persists git headers; configures ephemeral `GIT_ASKPASS`.
- `scripts/github_oauth_device.sh`: deprecated; verifies non-interactive auth instead.
- `scripts/git_non_interactive.sh`: helper to run git without prompts.
- `Makefile`: updated `gh.auth`, `gh.probe`, `gh.push`, `gh.oauth` to use non-interactive flows.

## CI/CD
- Added `.github/workflows/auth-smoke.yml`:
  - REST: `GET /rate_limit`
  - GraphQL: `{ viewer { login } }`
  - Git: `ls-remote` and `push --dry-run` via `GIT_ASKPASS`
- Workflows map `${{ github.token }}` to `GITHUB_PAT` for provider compatibility.

## Security & Hygiene
- Added `scripts/security/check_banned_github_auth.sh` and wired into pre-commit to block:
  - `gh auth login`, device/browser flows
  - `.netrc` for GitHub, tokens-in-URL, `Authorization: Basic` to GitHub API
- No GitHub tokens detected in working tree or sampled history.

## Docs & Config
- `docs/authentication.md` explains flows, scopes, environment, CI behavior.
- `SECURITY.md` updated with rotation and scrubbing guidance.
- `.env.example` provides required var names (no values).

## Tests
- Unit tests for token provider (PAT fallback, OAuthâ†’PAT failover, no-creds error): PASS locally.
- Integration tests added; skipped when env lacks credentials.

## Files Changed

 -  M .pre-commit-config.yaml
 -  M Makefile
 -  M README.md
 -  M SECURITY.md
 -  M scripts/github_api.sh
 -  M scripts/github_auth.sh
 -  M scripts/github_oauth_device.sh
 - ?? .bash_history
 - ?? .cache/
 - ?? .claude/
 - ?? .codex/
 - ?? .docker/
 - ?? .env.backup.2025-08-09-132358
 - ?? .env.example
 - ?? .github/workflows/auth-smoke.yml
 - ?? .local/
 - ?? .npm/
 - ?? .nvm/
 - ?? .smbcredentials
 - ?? .sudo_as_admin_successful
 - ?? codex/
 - ?? collections/Plex-Data-Collector-For-InfluxDB/
 - ?? collections/grafana/
 - ?? collections/pihole-secondary/etc-pihole/
 - ?? collections/pihole/adlists.list
 - ?? collections/pihole/cli_pw
 - ?? collections/pihole/config_backups/
 - ?? collections/pihole/dhcp.leases
 - ?? collections/pihole/dnsmasq.conf
 - ?? collections/pihole/etc-pihole/
 - ?? collections/pihole/gravity.db
 - ?? collections/pihole/gravity_backups/
 - ?? collections/pihole/gravity_old.db
 - ?? collections/pihole/hosts/
 - ?? collections/pihole/listsCache/
 - ?? collections/pihole/logrotate
 - ?? collections/pihole/migration_backup/
 - ?? collections/pihole/pihole-FTL.db
 - ?? collections/pihole/pihole-FTL.db-shm
 - ?? collections/pihole/pihole-FTL.db-wal
 - ?? collections/pihole/pihole.toml
 - ?? collections/pihole/versions
 - ?? collections/prometheus/targets/
 - ?? collections/swag/.donoteditthisfile.conf
 - ?? collections/swag/.migrations
 - ?? collections/swag/dns-conf/
 - ?? collections/swag/etc/
 - ?? collections/swag/fail2ban/
 - ?? collections/swag/nginx/
 - ?? collections/swag/php/
 - ?? collections/swag/www/
 - ?? collections/zabbix/mysql-new/
 - ?? collections/zabbix/mysql/
 - ?? docs/authentication.md
 - ?? internal/
 - ?? networking/collections/network-discovery/
 - ?? reports/
 - ?? resurgent/
 - ?? scripts/git_non_interactive.sh
 - ?? scripts/maintenance/docker_prune_safe.sh
 - ?? scripts/security/
 - ?? security/
 - ?? system_health/
 - ?? tests/integration/test_auth_smoke.py
 - ?? trash/
 - ?? var_lib_project_review/


## Next Steps
- Monitor CI `auth-smoke` job; ensure green on PRs and pushes.
- Consider migrating to GitHub App for finer-grained security in future.
- Periodically rotate PAT/OAuth credentials and validate scopes.
